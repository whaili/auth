openapi: 3.0.3
info:
  title: Bearer Token Service V2
  description: |
    认证服务 API

    ## 认证方式
    ### QiniuStub 认证
    七牛内部服务使用 QiniuStub 认证。

    #### 基本格式
    `QiniuStub uid={用户ID}&ut={用户类型}`

    #### 完整格式（支持更多参数）
    ```
    QiniuStub uid={用户ID}&ut={用户类型}[&app={应用ID}][&iuid={IAM用户ID}][&suid={代理用户ID}][&sut={代理用户类型}][&ak={AccessKey}][&eu={终端用户信息}]
    ```

    参数说明：
    - `uid`: （必填）用户ID
    - `ut`: （必填）用户类型
    - `app`: （可选）应用ID（Appid）
    - `iuid`: （可选）IAM 用户ID（IamUid）
    - `suid`: （可选）代理用户ID（Sudoer）
    - `sut`: （可选）代理用户类型（UtypeSu），仅当 suid 存在时有效
    - `ak`: （可选）AccessKey
    - `eu`: （可选）终端用户信息（EndUser）
  version: 2.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
servers:
  - url: http://localhost:8080
    description: 本地开发环境
  - url: http://bearer.qiniu.io
    description: 生产环境

tags:
  - name: Token 管理
    description: Bearer Token 的创建、查询、更新、删除
  - name: Token 验证
    description: Bearer Token 的验证和权限检查
  - name: 健康检查
    description: 服务健康状态检查

paths:
  /health:
    get:
      summary: 健康检查
      description: 检查服务运行状态
      tags:
        - 健康检查
      responses:
        '200':
          description: 服务正常运行
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/v2/tokens:
    post:
      summary: 创建 Bearer Token
      description: |
        创建一个新的 Bearer Token。

        **认证方式**: QiniuStub 认证

        **主账户示例**:
        ```
        Authorization: QiniuStub uid=1369077332&ut=1
        ```

        **IAM 子账户示例**:
        ```
        Authorization: QiniuStub uid=1369077332&ut=1&iuid=8901234
        ```
      tags:
        - Token 管理
      security:
        - QstubAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - description
              properties:
                description:
                  type: string
                  description: Token 描述
                  example: Production token
                expires_in_seconds:
                  type: integer
                  description: 过期时间（秒），0 表示永不过期
                  example: 7776000
                prefix:
                  type: string
                  description: 自定义 Token 前缀（支持小写字母、数字和下划线，最大 12 字符，系统自动添加分隔线，如 mk 生成 mk-xxx）
                  maxLength: 12
                  pattern: "^[a-z0-9_]+$"
                  example: mk
                rate_limit:
                  type: object
                  description: API 频率限制
                  properties:
                    requests_per_minute:
                      type: integer
                      example: 1000
      responses:
        '201':
          description: Token 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Token'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      summary: 列出 Tokens
      description: 列出当前账户的所有 Tokens
      tags:
        - Token 管理
      security:
        - QstubAuth: []
      parameters:
        - name: active_only
          in: query
          description: 仅显示激活的 Token
          schema:
            type: boolean
            default: false
        - name: limit
          in: query
          description: 返回数量（最大 100）
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          description: 偏移量
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Token 列表获取成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  account_id:
                    type: string
                    description: 账户 ID（格式为 qiniu_{uid}）
                    example: qiniu_1234567
                  tokens:
                    type: array
                    items:
                      $ref: '#/components/schemas/TokenSummary'
                  total:
                    type: integer
                    example: 1
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v2/tokens/{token_id}:
    get:
      summary: 获取 Token 详情
      description: 获取单个 Token 的详细信息
      tags:
        - Token 管理
      security:
        - QstubAuth: []
      parameters:
        - name: token_id
          in: path
          required: true
          description: Token ID
          schema:
            type: string
            example: tk_9z8y7x6w5v4u
      responses:
        '200':
          description: Token 详情获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: 删除 Token
      description: 永久删除 Token
      tags:
        - Token 管理
      security:
        - QstubAuth: []
      parameters:
        - name: token_id
          in: path
          required: true
          description: Token ID
          schema:
            type: string
            example: tk_9z8y7x6w5v4u
      responses:
        '200':
          description: Token 删除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Token deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v2/tokens/{token_id}/status:
    put:
      summary: 更新 Token 状态
      description: 启用或禁用 Token
      tags:
        - Token 管理
      security:
        - QstubAuth: []
      parameters:
        - name: token_id
          in: path
          required: true
          description: Token ID
          schema:
            type: string
            example: tk_9z8y7x6w5v4u
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - is_active
              properties:
                is_active:
                  type: boolean
                  description: Token 激活状态
                  example: false
      responses:
        '200':
          description: Token 状态更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Token status updated successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v2/tokens/{token_id}/stats:
    get:
      summary: 获取 Token 使用统计
      description: 查看 Token 的使用情况
      tags:
        - Token 管理
      security:
        - QstubAuth: []
      parameters:
        - name: token_id
          in: path
          required: true
          description: Token ID
          schema:
            type: string
            example: tk_9z8y7x6w5v4u
      responses:
        '200':
          description: Token 统计信息获取成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  token_id:
                    type: string
                    example: tk_9z8y7x6w5v4u
                  total_requests:
                    type: integer
                    example: 12567
                  last_used_at:
                    type: string
                    format: date-time
                    example: 2025-12-25T09:45:00Z
                  created_at:
                    type: string
                    format: date-time
                    example: 2025-12-25T10:00:00Z
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v2/validate:
    post:
      summary: 验证 Bearer Token
      description: 验证 Token 的有效性
      tags:
        - Token 验证
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token 验证成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Token is valid
                  token_info:
                    type: object
                    properties:
                      token_id:
                        type: string
                        example: tk_9z8y7x6w5v4u
                      uid:
                        type: string
                        example: "1234567"
                      iuid:
                        type: string
                        description: IAM 用户ID（当请求中包含 iuid 时返回，用于标识IAM用户）
                        example: "8901234"
                      is_active:
                        type: boolean
                        example: true
                      expires_at:
                        type: string
                        format: date-time
                        example: 2026-03-25T10:00:00Z
        '401':
          description: Token 验证失败
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Token has expired

  /api/v2/validateu:
    post:
      summary: 验证 Bearer Token（扩展用户信息）
      description: |
        验证 Token 的有效性，并返回扩展的用户信息（通过 Qconf RPC 查询）。

        **与 /api/v2/validate 的区别**:
        - 返回更丰富的用户信息（包括 Utype、Email、Username 等）
        - 用户信息通过 Qconf RPC 远程调用查询
        - 如果 Qconf RPC 查询失败，返回基本信息（user_info 为 null），Token 验证仍然成功

        **优雅降级**:
        当 Qconf RPC 查询失败时，接口仍返回 200 状态码，但 user_info 字段为 null。这确保 Token 验证功能不会因外部服务问题而受影响。
      tags:
        - Token 验证
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token 验证成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenValidateUResponse'
              examples:
                success_with_userinfo:
                  summary: 验证成功（包含用户信息）
                  value:
                    valid: true
                    message: Token is valid
                    token_info:
                      token_id: tk_9z8y7x6w5v4u
                      uid: "1369077332"
                      iuid: "8901234"
                      is_active: true
                      expires_at: 2026-03-25T10:00:00Z
                      user_info:
                        uid: 1369077332
                        email: user@example.com
                        username: 测试用户
                        utype: 268435460
                        activated: true
                        disabled_type: 0
                        disabled_reason: ""
                        parent_uid: 0
                        created_at: 1609459200
                        updated_at: 1704067200
                        last_login_at: 1735689600
                success_without_userinfo:
                  summary: 验证成功（Qconf RPC 查询失败，优雅降级）
                  value:
                    valid: true
                    message: Token is valid
                    token_info:
                      token_id: tk_9z8y7x6w5v4u
                      uid: "1369077332"
                      iuid: "8901234"
                      is_active: true
                      expires_at: 2026-03-25T10:00:00Z
                      user_info: null
        '401':
          description: Token 验证失败
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Token has expired

components:
  securitySchemes:
    QstubAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        QiniuStub 认证（七牛内部服务）

        基本格式: `QiniuStub uid=1369077332&ut=1`

        完整格式示例: `QiniuStub uid=1369077332&ut=1&app=100&suid=9876543&sut=2&ak=myAccessKey&eu=enduser@example.com`

        可选参数包括: app, iuid, suid, sut, ak, eu

    BearerAuth:
      type: http
      scheme: bearer
      description: |
        Bearer Token 认证

        格式: `Bearer <TOKEN>`

  schemas:
    Token:
      type: object
      description: Token 创建响应（完整 token 仅在创建时返回一次）
      properties:
        token_id:
          type: string
          example: tk_9z8y7x6w5v4u
        token:
          type: string
          description: 完整 token 值（仅在创建时返回，请妥善保存）
          example: mk-a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
        account_id:
          type: string
          description: 账户 ID（格式为 qiniu_{uid}）
          example: qiniu_1234567
        description:
          type: string
          example: Production token
        rate_limit:
          type: object
          description: API 频率限制配置
          properties:
            requests_per_minute:
              type: integer
              example: 1000
            requests_per_hour:
              type: integer
              example: 10000
            requests_per_day:
              type: integer
              example: 100000
        created_at:
          type: string
          format: date-time
          example: 2025-12-25T10:00:00Z
        expires_at:
          type: string
          format: date-time
          description: 过期时间（null 表示永不过期）
          example: 2026-03-25T10:00:00Z
        is_active:
          type: boolean
          example: true

    TokenSummary:
      type: object
      properties:
        token_id:
          type: string
          example: tk_9z8y7x6w5v4u
        token_preview:
          type: string
          description: Token 预览（中间隐藏）
          example: sk-a1b2c3d4****e5f6g7h8
        description:
          type: string
          example: Production token
        rate_limit:
          type: object
          description: API 频率限制配置
          properties:
            requests_per_minute:
              type: integer
              example: 1000
            requests_per_hour:
              type: integer
              example: 10000
            requests_per_day:
              type: integer
              example: 100000
        created_at:
          type: string
          format: date-time
          example: 2025-12-25T10:00:00Z
        expires_at:
          type: string
          format: date-time
          description: 过期时间（null 表示永不过期）
          example: 2026-03-25T10:00:00Z
        is_active:
          type: boolean
          example: true
        status:
          type: string
          description: Token 综合状态
          enum:
            - normal
            - expired
            - disabled
          example: normal
        total_requests:
          type: integer
          example: 12567
        last_used_at:
          type: string
          format: date-time
          description: 最后使用时间（null 表示从未使用）
          example: 2025-12-25T09:45:00Z

    TokenValidateUResponse:
      type: object
      description: /api/v2/validateu 响应（包含扩展用户信息）
      properties:
        valid:
          type: boolean
          description: Token 是否有效
          example: true
        message:
          type: string
          description: 响应消息
          example: Token is valid
        token_info:
          $ref: '#/components/schemas/TokenInfoU'

    TokenInfoU:
      type: object
      description: Token 信息（包含扩展用户信息）
      properties:
        token_id:
          type: string
          example: tk_9z8y7x6w5v4u
        account_id:
          type: string
          description: 账户 ID（HMAC 用户使用）
          example: qiniu_1234567
        uid:
          type: string
          description: 七牛 UID（从 account_id 提取）
          example: "1369077332"
        iuid:
          type: string
          description: IAM 用户ID
          example: "8901234"
        is_active:
          type: boolean
          example: true
        expires_at:
          type: string
          format: date-time
          description: 过期时间（null 表示永不过期）
          example: 2026-03-25T10:00:00Z
        last_used_at:
          type: string
          format: date-time
          description: 最后使用时间
          example: 2026-02-04T10:30:00Z
        user_info:
          $ref: '#/components/schemas/UserInfo'

    UserInfo:
      type: object
      description: |
        扩展用户信息（通过 Qconf RPC 查询）

        **Utype 字段说明**:
        Utype 是一个 32 位无符号整数，使用位掩码表示用户类型和状态。常用位包括：
        - bit 0: 管理员
        - bit 2: 企业用户
        - bit 16: 缓冲期用户
        - bit 28: 已禁用
        - bit 29: 海外用户
        - bit 30: 海外标准用户

        **判断用户类型**:
        使用位运算判断，例如：
        - 是否被禁用: `(utype & (1 << 28)) != 0`
        - 是否企业用户: `(utype & (1 << 2)) != 0`

        **优雅降级**:
        当 Qconf RPC 查询失败时，此字段为 null。
      nullable: true
      properties:
        uid:
          type: integer
          format: uint32
          description: 七牛用户 ID
          example: 1369077332
        email:
          type: string
          description: 用户邮箱
          example: user@example.com
        username:
          type: string
          description: 用户显示名称
          example: 测试用户
        utype:
          type: integer
          format: uint32
          description: 用户类型位掩码（见上方说明）
          example: 268435460
        activated:
          type: boolean
          description: 是否已激活
          example: true
        disabled_type:
          type: integer
          description: 冻结类型（0 表示未冻结）
          example: 0
        disabled_reason:
          type: string
          description: 冻结原因
          example: ""
        disabled_at:
          type: string
          format: date-time
          description: 冻结时间
          nullable: true
        parent_uid:
          type: integer
          format: uint32
          description: 父账户 UID（0 表示无父账户）
          example: 0
        created_at:
          type: integer
          format: int64
          description: 创建时间（Unix 时间戳，秒）
          example: 1609459200
        updated_at:
          type: integer
          format: int64
          description: 更新时间（Unix 时间戳，秒）
          example: 1704067200
        last_login_at:
          type: integer
          format: int64
          description: 最后登录时间（Unix 时间戳，秒）
          example: 1735689600

    Error:
      type: object
      description: |
        错误响应结构

        ## 业务错误码说明

        ### 认证相关 (4001-4099)
        | 错误码 | 消息 | 说明 |
        |--------|------|------|
        | 4004 | Invalid bearer token | Bearer Token 无效 |
        | 4005 | Token has expired | Token 已过期 |
        | 4006 | Token is disabled | Token 已被禁用 |

        ### 资源相关 (4041-4099)
        | 错误码 | 消息 | 说明 |
        |--------|------|------|
        | 4041 | Token not found | Token 不存在 |
        | 4042 | Account not found | 账户不存在 |

        ### 限流相关 (4291-4299)
        | 错误码 | 消息 | 说明 |
        |--------|------|------|
        | 4291 | Too many requests | 请求频率超限 |
        | 4292 | Rate limit exceeded | Token 频率限制超限 |
      properties:
        code:
          type: integer
          description: 业务错误码
          example: 4004
        message:
          type: string
          description: 错误消息
          example: Invalid bearer token
        details:
          type: string
          description: 错误详情
          example: The provided token is invalid or malformed
        request_id:
          type: string
          description: 请求追踪 ID
          example: req_abc123

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: 400
            message: Invalid request parameters
            details: Missing required field 'description'
            request_id: req_abc123

    Unauthorized:
      description: 认证失败
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalid_token:
              summary: Token 无效
              value:
                code: 4004
                message: Invalid bearer token
                details: The provided token is invalid or malformed
                request_id: req_abc123
            token_expired:
              summary: Token 已过期
              value:
                code: 4005
                message: Token has expired
                details: The token has expired, please create a new one
                request_id: req_abc123
            token_disabled:
              summary: Token 已禁用
              value:
                code: 4006
                message: Token is disabled
                details: The token has been disabled
                request_id: req_abc123
            qstub_auth_failed:
              summary: QiniuStub 认证失败
              value:
                code: 401
                message: Authentication failed
                details: Invalid QiniuStub authorization header
                request_id: req_abc123

    Forbidden:
      description: 权限不足
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: 403
            message: Permission denied
            details: Insufficient permissions for this operation
            request_id: req_abc123

    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            token_not_found:
              summary: Token 不存在
              value:
                code: 4041
                message: Token not found
                details: The requested token does not exist
                request_id: req_abc123
            account_not_found:
              summary: 账户不存在
              value:
                code: 4042
                message: Account not found
                details: The requested account does not exist
                request_id: req_abc123

    TooManyRequests:
      description: 请求过于频繁
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            app_rate_limit:
              summary: 应用级限流
              value:
                code: 4291
                message: Too many requests
                details: Rate limit exceeded
                request_id: req_abc123
            token_rate_limit:
              summary: Token级限流
              value:
                code: 4292
                message: Rate limit exceeded
                details: Token rate limit exceeded
                request_id: req_abc123

    InternalServerError:
      description: 服务器内部错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: 500
            message: Internal server error
            details: An unexpected error occurred
            request_id: req_abc123

    ServiceUnavailable:
      description: 服务不可用
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: 503
            message: Service unavailable
            details: The service is temporarily unavailable, please try again later
            request_id: req_abc123