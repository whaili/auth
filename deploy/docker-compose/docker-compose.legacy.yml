# ========================================
# Bearer Token Service V2 - Docker Compose (Legacy)
# ========================================
# å…¼å®¹ docker-compose 1.25.0+ ç‰ˆæœ¬
# âš ï¸ æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä¸æ”¯æŒ profiles å’Œå¥åº·æ£€æŸ¥ä¾èµ–
#
# éƒ¨ç½²æ¨¡å¼ï¼š
#   1. æœ¬åœ°å¼€å‘/æµ‹è¯•: å¯åŠ¨ mongodb æœåŠ¡
#      docker-compose -f docker-compose.legacy.yml up -d redis mongodb mongodb-init bearer-token-service nginx
#   2. ç”Ÿäº§ç¯å¢ƒ: è·³è¿‡ mongodbï¼Œä½¿ç”¨å¤–éƒ¨æ•°æ®åº“
#      docker-compose -f docker-compose.legacy.yml up -d redis bearer-token-service-production nginx
# ========================================

version: '3.7'

services:
  # ========================================
  # Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼Œæå‡æ€§èƒ½ï¼‰
  # ========================================
  redis:
    image: redis:7.2-alpine
    container_name: bearer-token-redis
    restart: unless-stopped
    command: ["sh", "-c", "redis-server --appendonly yes $${REDIS_PASSWORD:+--requirepass $$REDIS_PASSWORD}"]
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis_data:/data
    networks:
      - bearer-token-net
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ========================================
  # MongoDB æ•°æ®åº“ï¼ˆä»…ç”¨äºæœ¬åœ°å¼€å‘/æµ‹è¯•ï¼‰
  # ========================================
  mongodb:
    image: mongo:7.0
    container_name: bearer-token-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
    volumes:
      # æ•°æ®æŒä¹…åŒ–ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»æŒ‚è½½ï¼‰
      - mongodb_data:/data/db
      # é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      - mongodb_config:/data/configdb
    networks:
      - bearer-token-net
    ports:
      # åªåœ¨éœ€è¦å¤–éƒ¨è®¿é—®æ—¶æš´éœ²ï¼ˆç”Ÿäº§å»ºè®®ä¸æš´éœ²ï¼‰
      - "27017:27017"
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ========================================
  # MongoDB åˆå§‹åŒ–ï¼ˆä»…ç”¨äºæœ¬åœ°æ¨¡å¼ï¼‰
  # ========================================
  mongodb-init:
    image: mongo:latest
    container_name: bearer-token-mongodb-init
    # æ³¨æ„ï¼šv3.7 ä¸æ”¯æŒå¥åº·æ£€æŸ¥æ¡ä»¶ï¼Œéœ€è¦ç­‰å¾… MongoDB å°±ç»ªåå†å¯åŠ¨
    depends_on:
      - mongodb
    environment:
      MONGO_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_DATABASE: ${MONGO_DATABASE:-token_service_v2}
    volumes:
      - ./scripts/init:/scripts/init:ro
    networks:
      - bearer-token-net
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo 'â³ ç­‰å¾… MongoDB å°±ç»ª...'
        while ! mongosh "mongodb://mongodb:27017/admin" --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; do
          echo '   MongoDB å°šæœªå°±ç»ªï¼Œ5ç§’åé‡è¯•...'
          sleep 5
        done
        echo 'âœ… MongoDB å·²å°±ç»ª'
        echo ''
        echo 'ğŸ”§ åˆå§‹åŒ–æ•°æ®åº“ç´¢å¼•...'
        if mongosh "mongodb://$${MONGO_USERNAME}:$${MONGO_PASSWORD}@mongodb:27017/$${MONGO_DATABASE}?authSource=admin" --file /scripts/init/init-indexes.js --quiet; then
          echo 'âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ'
        else
          echo 'âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥'
          exit 1
        fi
    restart: "no"

  # ========================================
  # Bearer Token Service - æœ¬åœ°æ¨¡å¼
  # ========================================
  bearer-token-service:
    image: bearer-token-service:${VERSION:-latest}
    container_name: bearer-token-service
    restart: unless-stopped
    # æ³¨æ„ï¼šv3.7 ä¸æ”¯æŒ conditionï¼Œåªèƒ½ç®€å•ä¾èµ–
    depends_on:
      - mongodb
      - mongodb-init
      - redis
    networks:
      bearer-token-net:
        aliases:
          - backend
    environment:
      # åŸºç¡€é…ç½®
      PORT: ${PORT:-8080}
      MONGO_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/${MONGO_DATABASE:-token_service_v2}?authSource=admin

      # æ•°æ®åº“ç´¢å¼•ç®¡ç†ï¼ˆæœ¬åœ°æ¨¡å¼ç”± mongodb-init åˆ›å»ºï¼‰
      SKIP_INDEX_CREATION: ${SKIP_INDEX_CREATION:-true}

      # è´¦æˆ·æŸ¥è¯¢é…ç½®
      ACCOUNT_FETCHER_MODE: ${ACCOUNT_FETCHER_MODE:-local}
      EXTERNAL_ACCOUNT_API_URL: ${EXTERNAL_ACCOUNT_API_URL:-}
      EXTERNAL_ACCOUNT_API_TOKEN: ${EXTERNAL_ACCOUNT_API_TOKEN:-}

      # UID æ˜ å°„é…ç½®
      QINIU_UID_MAPPER_MODE: ${QINIU_UID_MAPPER_MODE:-simple}
      QINIU_UID_AUTO_CREATE: ${QINIU_UID_AUTO_CREATE:-false}

      # HMAC é…ç½®
      HMAC_TIMESTAMP_TOLERANCE: ${HMAC_TIMESTAMP_TOLERANCE:-15m}

      # Redis ç¼“å­˜é…ç½®
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      REDIS_ADDR: ${REDIS_ADDR:-redis:6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      CACHE_TOKEN_TTL: ${CACHE_TOKEN_TTL:-5m}

      # å¯è§‚æµ‹æ€§é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      LOG_FILE: ${LOG_FILE:-}

      # MongoDB è¿æ¥é‡è¯•é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
      MONGO_CONNECT_TIMEOUT: 30s
      MONGO_MAX_RETRIES: 10
      MONGO_RETRY_INTERVAL: 5s
    volumes:
      # æ—¥å¿—æŒä¹…åŒ–
      - ./logs:/app/logs
    ports:
      - "${HOST_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ========================================
  # Bearer Token Service - ç”Ÿäº§æ¨¡å¼ï¼ˆå¤–éƒ¨ MongoDBï¼‰
  # ========================================
  bearer-token-service-production:
    image: bearer-token-service:${VERSION:-latest}
    container_name: bearer-token-service-prod
    restart: unless-stopped
    depends_on:
      - redis
    networks:
      bearer-token-net:
        aliases:
          - backend
    environment:
      # åŸºç¡€é…ç½®
      PORT: ${PORT:-8080}

      # å¤–éƒ¨ MongoDB å‰¯æœ¬é›†é…ç½®ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
      # æ ¼å¼: mongodb://user:pass@host1:port1,host2:port2,host3:port3/dbname?replicaSet=rs0&authSource=admin
      MONGO_URI: ${MONGO_URI}

      # è´¦æˆ·æŸ¥è¯¢é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨è externalï¼‰
      ACCOUNT_FETCHER_MODE: ${ACCOUNT_FETCHER_MODE:-external}
      EXTERNAL_ACCOUNT_API_URL: ${EXTERNAL_ACCOUNT_API_URL}
      EXTERNAL_ACCOUNT_API_TOKEN: ${EXTERNAL_ACCOUNT_API_TOKEN}

      # UID æ˜ å°„é…ç½®
      QINIU_UID_MAPPER_MODE: ${QINIU_UID_MAPPER_MODE:-database}
      QINIU_UID_AUTO_CREATE: ${QINIU_UID_AUTO_CREATE:-false}

      # HMAC é…ç½®
      HMAC_TIMESTAMP_TOLERANCE: ${HMAC_TIMESTAMP_TOLERANCE:-10m}

      # Redis ç¼“å­˜é…ç½®
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      REDIS_ADDR: ${REDIS_ADDR:-redis:6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      CACHE_TOKEN_TTL: ${CACHE_TOKEN_TTL:-5m}

      # å¯è§‚æµ‹æ€§é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      LOG_FILE: ${LOG_FILE:-}

      # æ•°æ®åº“ç´¢å¼•ç®¡ç†ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»è·³è¿‡ï¼Œç”± init-db.sh ç»Ÿä¸€åˆ›å»ºï¼‰
      SKIP_INDEX_CREATION: ${SKIP_INDEX_CREATION:-true}
    volumes:
      # æ—¥å¿—æŒä¹…åŒ–
      - ./logs:/app/logs
    ports:
      - "${HOST_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ========================================
  # Nginx åå‘ä»£ç†ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
  # ========================================
  nginx:
    image: nginx:1.25-alpine
    container_name: bearer-token-nginx
    restart: unless-stopped
    # æ³¨æ„ï¼šæ ¹æ®ä½¿ç”¨çš„æœåŠ¡æ‰‹åŠ¨é€‰æ‹©ä¾èµ–
    # æœ¬åœ°æ¨¡å¼: depends_on: [bearer-token-service]
    # ç”Ÿäº§æ¨¡å¼: depends_on: [bearer-token-service-production]
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - bearer-token-net
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

# ========================================
# ç½‘ç»œé…ç½®
# ========================================
networks:
  bearer-token-net:
    driver: bridge

# ========================================
# æ•°æ®å·
# ========================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
