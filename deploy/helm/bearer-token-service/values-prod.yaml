# ========================================
# Bearer Token Service V2 - 生产环境配置
# ========================================
# MongoDB: 使用外部共用实例
# Redis: 部署独立实例

replicaCount: 4

# 生产环境镜像仓库
image:
  repository: registry-kubesphere-hd.qiniu.io/miku-stream/bearer-token-service
  tag: "v2.0.0"
  pullPolicy: Always

# 禁用内置 MongoDB（使用外部共用）
mongodb:
  enabled: false

# 启用 Nginx 反向代理
nginx:
  enabled: true
  replicaCount: 2
  image: registry-kubesphere-hd.qiniu.io/miku-stream/nginx:1.25-alpine
  service:
    type: ClusterIP
    port: 80
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# 启用内置 Redis（生产环境独立部署）
redis:
  enabled: true
  image: registry-kubesphere-hd.qiniu.io/miku-stream/redis:7.2-alpine
  storage: 5Gi
  storageClassName: ""
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# 外部 MongoDB 配置
externalMongodb:
  uri: "mongodb://bearer_token_wr:ovViaN5wgBVwKuXIkVzqCBqoYIc2zkgu@10.70.65.41:27019,10.70.65.34:27019,10.70.65.39:27019/bearer_token_main?authSource=admin"

# 启用 Ingress
ingress:
  enabled: true
  className: ""
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
  host: bearer-token.qiniu.io
  tls: []
  # - secretName: bearer-token-tls
  #   hosts:
  #     - bearer-token.qiniu.io

# 生产环境资源配置
resources:
  requests:
    cpu: 1000m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 2Gi

# 启用 HPA
hpa:
  enabled: true
  minReplicas: 4
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# 生产环境配置
config:
  ginMode: "release"
  logLevel: "info"
  mongoDatabase: "bearer_token_main"
  skipIndexCreation: "true"
  rateLimit:
    app: true
    account: true
    token: true

# 生产环境安全上下文
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Pod 反亲和性（分散部署）
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - bearer-token-service
          topologyKey: kubernetes.io/hostname
