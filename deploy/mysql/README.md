# æµ‹è¯•æ•°æ®è¿ç§»è„šæœ¬

ä»ç”Ÿäº§ç¯å¢ƒ MySQL å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼Œè¿›è¡Œæ•°æ®æ··æ·†åå¯¼å…¥æµ‹è¯•ç¯å¢ƒã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [å‰ç½®è¦æ±‚](#å‰ç½®è¦æ±‚)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯¦ç»†è¯´æ˜](#è¯¦ç»†è¯´æ˜)
- [æ•°æ®æ··æ·†è§„åˆ™](#æ•°æ®æ··æ·†è§„åˆ™)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## åŠŸèƒ½ç‰¹æ€§

- âœ… ä»ç”Ÿäº§ MySQL å®‰å…¨å¯¼å‡ºæ•°æ®
- âœ… è‡ªåŠ¨æ··æ·†æ•æ„Ÿä¿¡æ¯ï¼ˆé‚®ç®±ã€ç”¨æˆ·åã€å¯†ç ã€IPã€æ‰‹æœºå·ï¼‰
- âœ… æ”¯æŒè‡ªå®šä¹‰æ•°æ®åº“åç§°å’Œå¯¼å‡ºæ•°é‡
- âœ… å®Œæ•´çš„é”™è¯¯æ£€æŸ¥å’Œç½‘ç»œè¿é€šæ€§éªŒè¯
- âœ… å¯¼å…¥åè‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§

## å‰ç½®è¦æ±‚

### ç¯å¢ƒè¦æ±‚

1. **æœ¬åœ°å¼€å‘æœºéœ€è¦**:
   - èƒ½å¤Ÿ SSH åˆ° `vmyzh165`ï¼ˆç”Ÿäº§æœåŠ¡å™¨ï¼‰
   - èƒ½å¤Ÿè®¿é—®æµ‹è¯• MySQL (`10.210.31.54:3306`)
   - å®‰è£… `mysql` å®¢æˆ·ç«¯
   - å®‰è£… `python3`
   - å®‰è£… `openssh-client`

2. **ç½‘ç»œæ‹“æ‰‘**:
   ```
   æœ¬åœ°å¼€å‘æœº --SSH--> vmyzh165 (ç”Ÿäº§æœåŠ¡å™¨) --ç½‘ç»œ--> ç”Ÿäº§MySQL (10.70.67.40)
   æœ¬åœ°å¼€å‘æœº --ç½‘ç»œ--> æµ‹è¯•MySQL (10.210.31.54)
   ```

### å®‰è£…ä¾èµ–

```bash
# Ubuntu/Debian
sudo apt-get install mysql-client python3 openssh-client

# CentOS/RHEL
sudo yum install mysql python3 openssh-clients
```

### SSH é…ç½®

ç¡®ä¿å¯ä»¥æ— å¯†ç  SSH åˆ° vmyzh165ï¼š

```bash
# æµ‹è¯• SSH è¿æ¥
ssh vmyzh165 "echo 'SSH OK'"

# å¦‚æœæç¤ºè¾“å…¥å¯†ç ï¼Œé…ç½® SSH å¯†é’¥
ssh-copy-id vmyzh165
```

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```bash
cd /root/src/auth

# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆå¯¼å‡º500æ¡ï¼Œæ•°æ®åº“å: bearer_token_test_<username>ï¼‰
./scripts/migrate_test_data.sh
```

### è‡ªå®šä¹‰é…ç½®

```bash
# æŒ‡å®šæ•°æ®åº“åç§°
./scripts/migrate_test_data.sh --db-name my_test_db

# æŒ‡å®šå¯¼å‡ºæ•°é‡
./scripts/migrate_test_data.sh --limit 1000

# ç»„åˆä½¿ç”¨
./scripts/migrate_test_data.sh --db-name bearer_test_20260204 --limit 200
```

### æŸ¥çœ‹å¸®åŠ©

```bash
./scripts/migrate_test_data.sh --help
```

## è¯¦ç»†è¯´æ˜

### æ‰§è¡Œæµç¨‹

è„šæœ¬ä¼šæŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

1. **ä¾èµ–æ£€æŸ¥** - éªŒè¯ mysqlã€python3ã€ssh æ˜¯å¦å·²å®‰è£…
2. **ç½‘ç»œæ£€æŸ¥** - æµ‹è¯•åˆ°ç”Ÿäº§æœåŠ¡å™¨å’Œæµ‹è¯• MySQL çš„è¿é€šæ€§
3. **å¯¼å‡ºæ•°æ®** - é€šè¿‡ SSH ä» vmyzh165 è¿æ¥ç”Ÿäº§ MySQL å¯¼å‡ºæ•°æ®
4. **æ··æ·†æ•°æ®** - ä½¿ç”¨ Python è„šæœ¬æ··æ·†æ•æ„Ÿä¿¡æ¯
5. **åˆ›å»ºæ•°æ®åº“** - åœ¨æµ‹è¯• MySQL åˆ›å»ºç›®æ ‡æ•°æ®åº“
6. **å¯¼å…¥æ•°æ®** - å°†æ··æ·†åçš„æ•°æ®å¯¼å…¥æµ‹è¯•æ•°æ®åº“
7. **éªŒè¯æ•°æ®** - æ£€æŸ¥å¯¼å…¥çš„è®°å½•æ•°å’Œæ•°æ®å®Œæ•´æ€§

### ç¯å¢ƒé…ç½®

è„šæœ¬å†…ç½®ä»¥ä¸‹é…ç½®ï¼š

```bash
# ç”Ÿäº§ç¯å¢ƒ
PROD_SERVER="vmyzh165"
PROD_HOST="10.70.67.40"
PROD_PORT="3306"
PROD_USER="chatnio"
PROD_DATABASE="chatnio"
PROD_TABLE="auth"

# æµ‹è¯•ç¯å¢ƒ
TEST_HOST="10.210.31.54"
TEST_PORT="3306"
TEST_USER="bo"
TEST_PASSWORD="bo"
```

å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç¼–è¾‘è„šæœ¬é¡¶éƒ¨çš„é…ç½®éƒ¨åˆ†ã€‚

### è¾“å‡ºç¤ºä¾‹

```
====================================================================
[INFO] ğŸš€ MySQL æµ‹è¯•æ•°æ®è¿ç§»è„šæœ¬
====================================================================

[STEP] æ£€æŸ¥ä¾èµ–...
[INFO] ä¾èµ–æ£€æŸ¥é€šè¿‡ âœ“

[STEP] æ£€æŸ¥ç½‘ç»œè¿é€šæ€§...
[INFO] âœ“ å¯ä»¥è¿æ¥åˆ°ç”Ÿäº§æœåŠ¡å™¨: vmyzh165
[INFO] âœ“ å¯ä»¥è¿æ¥åˆ°æµ‹è¯• MySQL: 10.210.31.54:3306
[INFO] ç½‘ç»œè¿é€šæ€§æ£€æŸ¥é€šè¿‡ âœ“

[STEP] ä»ç”Ÿäº§ç¯å¢ƒå¯¼å‡ºæ•°æ®...
[INFO]   æœåŠ¡å™¨: vmyzh165
[INFO]   MySQL: 10.70.67.40:3306
[INFO]   æ•°æ®åº“: chatnio.auth
[INFO]   é™åˆ¶: 500 æ¡è®°å½•
[INFO] å¯¼å‡ºè¡¨ç»“æ„...
[INFO] å¯¼å‡ºæ•°æ®ï¼ˆå‰ 500 æ¡ï¼‰...
[INFO] æˆåŠŸå¯¼å‡º 500 æ¡è®°å½• âœ“

[STEP] æ··æ·†æ•æ„Ÿæ•°æ®...
[INFO] æ··æ·†å­—æ®µ: email, username, å¯†ç å“ˆå¸Œ, IPåœ°å€, æ‰‹æœºå·
[INFO] æ•°æ®æ··æ·†å®Œæˆ âœ“

[STEP] åˆ›å»ºæµ‹è¯•æ•°æ®åº“: bearer_token_test_gem
[INFO] æ•°æ®åº“åˆ›å»ºæˆåŠŸ âœ“

[STEP] å¯¼å…¥æ•°æ®åˆ°æµ‹è¯•ç¯å¢ƒ...
[INFO]   MySQL: 10.210.31.54:3306
[INFO]   æ•°æ®åº“: bearer_token_test_gem
[INFO] æˆåŠŸå¯¼å…¥ 500 æ¡è®°å½• âœ“

[STEP] éªŒè¯å¯¼å…¥æ•°æ®...
[INFO] éªŒè¯é€šè¿‡ï¼šå…± 500 æ¡è®°å½• âœ“

====================================================================
[INFO] âœ… æµ‹è¯•æ•°æ®å¯¼å…¥å®Œæˆï¼
====================================================================
```

## æ•°æ®æ··æ·†è§„åˆ™

ä¸ºä¿æŠ¤ç”Ÿäº§æ•°æ®éšç§ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨æ··æ·†ä»¥ä¸‹æ•æ„Ÿä¿¡æ¯ï¼š

### 1. é‚®ç®±åœ°å€

- **è§„åˆ™**: ä¿ç•™åŸŸåï¼Œæ··æ·†ç”¨æˆ·åéƒ¨åˆ†
- **ç¤ºä¾‹**:
  ```
  åŸå§‹: zhangsan@example.com
  æ··æ·†: test_a1b2c3d4@example.com
  ```

### 2. ç”¨æˆ·åï¼ˆä¸­æ–‡ï¼‰

- **è§„åˆ™**: ä½¿ç”¨ MD5 å“ˆå¸Œç”Ÿæˆæµ‹è¯•ç”¨æˆ·å
- **ç¤ºä¾‹**:
  ```
  åŸå§‹: å¼ ä¸‰
  æ··æ·†: æµ‹è¯•ç”¨æˆ·_a1b2c3
  ```

### 3. å¯†ç å“ˆå¸Œ

- **è§„åˆ™**: æ›¿æ¢ä¸ºå›ºå®šçš„æµ‹è¯•å¯†ç å“ˆå¸Œï¼ˆå¯¹åº”å¯†ç : "password"ï¼‰
- **ç¤ºä¾‹**:
  ```
  åŸå§‹: $2a$10$N9qo8uLOickgx2ZMRZoMye...ï¼ˆåŸå§‹å“ˆå¸Œï¼‰
  æ··æ·†: $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
  ```

### 4. IP åœ°å€

- **è§„åˆ™**: ä¿ç•™å‰ä¸¤æ®µï¼Œåä¸¤æ®µéšæœºåŒ–
- **ç¤ºä¾‹**:
  ```
  åŸå§‹: 192.168.1.100
  æ··æ·†: 192.168.23.156
  ```

### 5. æ‰‹æœºå·

- **è§„åˆ™**: ä¿ç•™å‰3ä½å’Œå4ä½ï¼Œä¸­é—´ç”¨æ˜Ÿå·ä»£æ›¿
- **ç¤ºä¾‹**:
  ```
  åŸå§‹: 13812345678
  æ··æ·†: 138****5678
  ```

## ä½¿ç”¨æµ‹è¯•æ•°æ®åº“

### é…ç½®è¯´æ˜

è„šæœ¬æ‰§è¡Œå®Œæˆåä¼šæ˜¾ç¤ºæ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚å‡­æ®å·²é…ç½®åœ¨ `_cust/credentials.env` ä¸­ï¼š

```bash
# å‡­æ®å·²åœ¨ _cust/credentials.env ä¸­é…ç½®
# TEST_MYSQL_HOST="10.210.31.54"
# TEST_MYSQL_PORT="3306"
# TEST_MYSQL_USER="bo"
# TEST_MYSQL_PASSWORD="bo"
# TEST_MYSQL_DATABASE="bearer_token_test_gem"
```

### å¯åŠ¨æœåŠ¡

```bash
cd /root/src/auth

# ä½¿ç”¨ credentials.env
source _cust/credentials.env
go run cmd/server/main.go

# æˆ–è€…æ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡
MYSQL_HOST="${TEST_MYSQL_HOST}" \
MYSQL_PASSWORD="${TEST_MYSQL_PASSWORD}" \
MYSQL_DATABASE="${TEST_MYSQL_DATABASE}" \
go run cmd/server/main.go
```

### æµ‹è¯• API

```bash
# è·å–ä¸€ä¸ªæµ‹è¯•ç”¨çš„ UIDï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼‰
mysql -h ${TEST_MYSQL_HOST} -P ${TEST_MYSQL_PORT} -u ${TEST_MYSQL_USER} -p"${TEST_MYSQL_PASSWORD}" ${TEST_MYSQL_DATABASE} \
  -e "SELECT uid FROM auth LIMIT 1;"

# å‡è®¾ UID = 1369077332

# 1. åˆ›å»º Tokenï¼ˆä½¿ç”¨ QiniuStub è®¤è¯ï¼‰
curl -X POST http://localhost:8080/api/v2/tokens \
  -H 'Authorization: QiniuStub uid=1369077332&ut=1' \
  -H 'Content-Type: application/json' \
  -d '{
    "description": "æµ‹è¯•Token",
    "expires_in_seconds": 2592000
  }'

# 2. æµ‹è¯• validateu æ¥å£ï¼ˆä½¿ç”¨è¿”å›çš„ Bearer Tokenï¼‰
curl -X POST http://localhost:8080/api/v2/validateu \
  -H 'Authorization: Bearer sk-xxxxx...'
```

## å¸¸è§é—®é¢˜

### Q1: SSH è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `æ— æ³• SSH åˆ°ç”Ÿäº§æœåŠ¡å™¨: vmyzh165`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ SSH è¿æ¥
ssh vmyzh165

# å¦‚æœæç¤ºå¯†ç ï¼Œé…ç½®å¯†é’¥è®¤è¯
ssh-copy-id vmyzh165

# æˆ–è€…åœ¨ ~/.ssh/config ä¸­é…ç½®åˆ«å
cat >> ~/.ssh/config << EOF
Host vmyzh165
    HostName <å®é™…IP>
    User <ç”¨æˆ·å>
    IdentityFile ~/.ssh/id_rsa
EOF
```

### Q2: æµ‹è¯• MySQL è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `æ— æ³•è¿æ¥åˆ°æµ‹è¯• MySQL: 10.210.31.54:3306`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
telnet 10.210.31.54 3306

# æµ‹è¯• MySQL ç™»å½•ï¼ˆä½¿ç”¨ credentials.env ä¸­é…ç½®çš„å‡­æ®ï¼‰
source _cust/credentials.env
mysql -h ${TEST_MYSQL_HOST} -P ${TEST_MYSQL_PORT} -u ${TEST_MYSQL_USER} -p"${TEST_MYSQL_PASSWORD}" -e "SHOW DATABASES;"
```

### Q3: æ•°æ®åº“å·²å­˜åœ¨

å¦‚æœæ•°æ®åº“åç§°å†²çªï¼Œä½¿ç”¨ `--db-name` å‚æ•°æŒ‡å®šæ–°åç§°ï¼š

```bash
./scripts/migrate_test_data.sh --db-name bearer_test_$(date +%Y%m%d_%H%M%S)
```

### Q4: Python è„šæœ¬æŠ¥é”™

ç¡®ä¿å®‰è£…äº† Python 3ï¼š

```bash
python3 --version

# å¦‚æœæœªå®‰è£…
sudo apt-get install python3
```

### Q5: æ•°æ®é‡å¤ªå¤§

é»˜è®¤åªå¯¼å‡º 500 æ¡è®°å½•ï¼Œå¦‚æœéœ€è¦æ›´å¤šæˆ–æ›´å°‘ï¼š

```bash
# å¯¼å‡ºæ›´å°‘æ•°æ®ï¼ˆ100æ¡ï¼‰
./scripts/migrate_test_data.sh --limit 100

# å¯¼å‡ºæ›´å¤šæ•°æ®ï¼ˆ2000æ¡ï¼‰
./scripts/migrate_test_data.sh --limit 2000
```

### Q6: å¦‚ä½•åˆ é™¤æµ‹è¯•æ•°æ®åº“

```bash
# ä½¿ç”¨ credentials.env ä¸­é…ç½®çš„å‡­æ®
source _cust/credentials.env
mysql -h ${TEST_MYSQL_HOST} -P ${TEST_MYSQL_PORT} -u ${TEST_MYSQL_USER} -p"${TEST_MYSQL_PASSWORD}" \
  -e "DROP DATABASE IF EXISTS ${TEST_MYSQL_DATABASE};"
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **å¯†ç ä¿æŠ¤**: æ‰€æœ‰æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ `_cust/credentials.env`ï¼Œè¯¥æ–‡ä»¶å·²åŠ å…¥ `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
2. **æ•°æ®æ··æ·†**: å¯¼å‡ºçš„æ•°æ®å·²æ··æ·†æ•æ„Ÿä¿¡æ¯ï¼Œä½†ä»è¯·å¦¥å–„ä¿ç®¡ä¸´æ—¶æ–‡ä»¶
3. **æƒé™æ§åˆ¶**: ç¡®ä¿æµ‹è¯•æ•°æ®åº“ä»…å¼€å‘äººå‘˜å¯è®¿é—®
4. **å®šæœŸæ¸…ç†**: å»ºè®®å®šæœŸåˆ é™¤ä¸å†ä½¿ç”¨çš„æµ‹è¯•æ•°æ®åº“

## è„šæœ¬ç»´æŠ¤

å¦‚éœ€ä¿®æ”¹æ··æ·†è§„åˆ™æˆ–é…ç½®ï¼Œç¼–è¾‘è„šæœ¬ä¸­çš„ä»¥ä¸‹éƒ¨åˆ†ï¼š

1. **é…ç½®éƒ¨åˆ†**ï¼ˆç¬¬12-30è¡Œï¼‰: ä¿®æ”¹æ•°æ®åº“è¿æ¥ä¿¡æ¯
2. **æ··æ·†å‡½æ•°**ï¼ˆç¬¬200-270è¡Œï¼‰: ä¿®æ”¹æ•°æ®æ··æ·†é€»è¾‘

## ç›¸å…³æ–‡æ¡£

- `../../_cust/credentials.env` - å‡­æ®é…ç½®ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
- `../../_cust/SECURITY_REVIEW.md` - å®‰å…¨å®¡æŸ¥æŠ¥å‘Š
- `../../CLAUDE.md` - é¡¹ç›®è¯´æ˜æ–‡æ¡£

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤å›¢é˜Ÿã€‚
